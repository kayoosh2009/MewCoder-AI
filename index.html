<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Vibe Coding Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs/loader.js"></script>
    <style>
        /* Глубокая темная тема и настройка скроллбаров */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #4f4f4f; }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1e1e1e; color: #d4d4d4; }
        .container { display: flex; height: 100vh; }
        
        /* Левая часть: ЧАТ */
        #chat-section { width: 30%; display: flex; flex-direction: column; border-right: 1px solid #333333; background: #252526; }
        #chat-header { padding: 15px; font-weight: bold; background: #2d2d30; border-bottom: 1px solid #3c3c3c; color: #cccccc; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; font-size: 14px; display: flex; flex-direction: column; gap: 15px; }
        
        .message { padding: 12px; border-radius: 6px; line-height: 1.4; word-wrap: break-word; white-space: pre-wrap; }
        .user-msg { background: #2d2d30; border: 1px solid #3c3c3c; align-self: flex-end; max-width: 85%; }
        .ai-msg { background: #094771; align-self: flex-start; max-width: 95%; }
        
        #input-area { padding: 15px; display: flex; gap: 10px; background: #2d2d30; border-top: 1px solid #3c3c3c; }
        input { flex: 1; background: #3c3c3c; border: 1px solid #3c3c3c; color: #d4d4d4; padding: 10px; border-radius: 4px; outline: none; transition: border 0.2s; }
        input:focus { border: 1px solid #007fd4; }
        
        button { cursor: pointer; background: #007fd4; color: white; border: none; padding: 10px 15px; border-radius: 4px; font-weight: bold; transition: background 0.2s; }
        button:hover { background: #006eb8; }

        /* Правая часть: КОД */
        #editor-section { width: 70%; height: 100%; }
        #editor-container { height: 100%; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <div id="chat-section">
        <div id="chat-header">AI Assistant (Qwen Coder)</div>
        <div id="messages"></div>
        <div id="input-area">
            <input type="text" id="user-input" placeholder="Напиши промпт и нажми Enter...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <div id="editor-section">
        <div id="editor-container"></div>
    </div>
</div>

<script>
    let editor;
    const API_KEY = "e77cd3172e7145bfb80de9c9054998ad.GjyCnVyJkEtNnTwA8bHJRRA6"; // Вставь сюда свой ключ

    // Инициализация редактора Monaco
    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
        editor = monaco.editor.create(document.getElementById('editor-container'), {
            value: "// Начни писать код здесь...\nfunction hello() {\n  console.log('Hello Vibe Coding!');\n}",
            language: 'javascript',
            theme: 'vs-dark',
            automaticLayout: true,
            minimap: { enabled: false } // Отключил мини-карту для чистоты интерфейса
        });
    });

    // Отправка по нажатию на Enter
    document.getElementById('user-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Функция отправки сообщения
    async function sendMessage() {
        const inputField = document.getElementById('user-input');
        const text = inputField.value.trim();
        const currentCode = editor.getValue(); 

        if (!text) return;

        addMessage(text, 'user-msg');
        inputField.value = '';

        const aiMsgDiv = addMessage('Thinking...', 'ai-msg');

        // СТРОГИЙ СИСТЕМНЫЙ ПРОМПТ ДЛЯ ИИ
        const systemPrompt = `Ты — ИИ-помощник для написания кода, встроенный в редактор.
Текущий код в редакторе:
${currentCode}

Твои строгие правила:
1. Выполняй строго только то, что просит пользователь. Не добавляй лишней информации или непрошеных советов.
2. Если пользователь просит изменить или дописать определенный участок кода, возвращай ТОЛЬКО этот измененный участок кода. Не пиши весь файл целиком, если об этом не просили.
3. Обязательно пиши комментарии к коду, который ты создаешь или изменяешь, чтобы объяснить логику.`;

        try {
            const response = await fetch('https://ollama.com/api/chat', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'gpt-oss:120b', // Замени на нужную тебе модель
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: text }
                    ],
                    stream: false
                })
            });

            const data = await response.json();
            
            // Если ответ содержит сообщение, выводим его
            if (data.message && data.message.content) {
                aiMsgDiv.innerText = data.message.content;
            } else {
                aiMsgDiv.innerText = "Пустой ответ от сервера.";
            }

        } catch (err) {
            aiMsgDiv.innerText = "Ошибка: " + err.message;
        }
    }

    function addMessage(text, className) {
        const div = document.createElement('div');
        div.className = `message ${className}`;
        div.innerText = text;
        const messagesContainer = document.getElementById('messages');
        messagesContainer.appendChild(div);
        
        // Автоматическая прокрутка чата вниз
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        return div;
    }
</script>

</body>
</html>
